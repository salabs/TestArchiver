name: Python package

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.5, 3.6, 3.7, 3.8]

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint==2.4.4 pytest mock setuptools wheel
        pip install -i https://test.pypi.org/simple/ testarchiver
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Lint with pylint
      run: |
        pylint test_archiver/
    - name: Run unittests
      run: |
        PYTHONPATH=. pytest test_archiver/tests/ --junit-xml=output.xml
    - name: Archive unittest results
      if: ${{ always() }}
      run: >-
        python3
        -m
        test_archiver.output_parser
        output.xml
        --database ${{ secrets.DEMO_ARCHIVE_NAME }}
        --host ${{ secrets.DEMO_ARCHIVE_NAME }}
        --host ${{ secrets.ARCHIVE_HOST }}
        --user ${{ secrets.ARCHIVE_USER }}
        --pw ${{ secrets.ARCHIVE_PW }}
        --dbengine postgres
        --format pytest-junit
        --repository TestArchiver
        --team TestArchiver
        --series archiver_unittests
        --series ${GITHUB_REF##*/}
    # Test packaging
    - name: Test building package
      run: |
        python setup.py sdist bdist_wheel
    - name: Test installing package
      run: |
        python -m pip install dist/testarchiver-*.tar.gz
